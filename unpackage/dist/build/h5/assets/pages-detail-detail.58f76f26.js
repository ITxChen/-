import{N as e,_ as t,y as i,z as a,e as s,ab as o,o as r,c as l,w as n,j as c,d as u,f as d,b as m,ac as h,i as p,r as f,D as g,m as _,p as v,x as y,E as b,a as x,t as w,n as k,g as T,h as z,F as $,A as C,l as S,q as A}from"./index-071c8e17.js";import{_ as B}from"./uni-dateformat.fdd7d24f.js";import{r as E}from"./uni-app.es.af5b3bc2.js";import{_ as L}from"./_plugin-vue_export-helper.1b428a4d.js";import{_ as j}from"./u-icon.92485f2b.js";import{_ as I}from"./panda.96b8acd4.js";import{s as N}from"./store.7e8d93e4.js";import{c as q}from"./tool.6da0bed1.js";import{c as O,a as M}from"./comment-frame.4aca7f64.js";import"./uni-easyinput.06277378.js";import"./uni-icons.c3f4a5ee.js";R(" , ,\t,\r,\n,\f"),R("allowfullscreen,autoplay,autostart,controls,ignore,loop,muted"),R("address,article,aside,body,caption,center,cite,footer,header,html,nav,pre,section"),R("area,base,canvas,frame,iframe,input,link,map,meta,param,script,source,style,svg,textarea,title,track,wbr"),R("a,colgroup,fieldset,legend"),R("area,base,br,col,circle,ellipse,embed,frame,hr,img,input,line,link,meta,param,path,polygon,rect,source,track,use,wbr"),R("a,abbr,ad,audio,b,blockquote,br,code,col,colgroup,dd,del,dl,dt,div,em,fieldset,h1,h2,h3,h4,h5,h6,hr,i,img,ins,label,legend,li,ol,p,q,source,span,strong,sub,sup,table,tbody,td,tfoot,th,thead,tr,title,ul,video");var H={address:"font-style:italic",big:"display:inline;font-size:1.2em",blockquote:"background-color:#f6f6f6;border-left:3px solid #dbdbdb;color:#6c6c6c;padding:5px 0 5px 10px",caption:"display:table-caption;text-align:center",center:"text-align:center",cite:"font-style:italic",dd:"margin-left:40px",mark:"background-color:yellow",pre:"font-family:monospace;white-space:pre;overflow:scroll",s:"text-decoration:line-through",small:"display:inline;font-size:0.8em",u:"text-decoration:underline"};function R(e){for(var t=Object.create(null),i=e.split(","),a=i.length;a--;)t[i[a]]=!0;return t}var{windowWidth:F,platform:W}=e();const D=L({name:"parser",emits:["parse","load","ready","error","imgtap","linkpress"],data(){return{uid:this._uid,showAm:"",nodes:[]}},props:{html:String,autopause:{type:Boolean,default:!0},preview:{type:Boolean,default:!0},autoscroll:Boolean,autosetTitle:{type:Boolean,default:!0},domain:String,lazyLoad:Boolean,selectable:Boolean,tagStyle:Object,showWithAnimation:Boolean,useAnchor:Boolean},watch:{html(e){this.setContent(e)}},created(){this.imgList=[],this.imgList.each=function(e){for(var t=0,i=this.length;t<i;t++)this.setItem(t,e(this[t],t,this))},this.imgList.setItem=function(e,t){if(null!=e&&t){if(0==t.indexOf("http")&&this.includes(t)){for(var i,a=t.split("://")[0],s=a.length;(i=t[s])&&("/"!=i||"/"==t[s-1]||"/"==t[s+1]);s++)a+=Math.random()>.5?i.toUpperCase():i;return a+=t.substr(s),this[e]=a}if(this[e]=t,t.includes("data:image"))if(!t.match(/data:image\/(\S+?);(\S+?),(.+)/))return}}},mounted(){this.document=document.getElementById("rtf"+this._uid),this.html&&this.setContent(this.html)},beforeUnmount(){this._observer&&this._observer.disconnect(),this.imgList.each((e=>{})),clearInterval(this._timer)},methods:{setContent(e,s){if(e){var o=document.createElement("div");s?this.rtf?this.rtf.appendChild(o):this.rtf=o:(this.rtf&&this.rtf.parentNode.removeChild(this.rtf),this.rtf=o),o.innerHTML=this._handleHtml(e,s);for(var r,l=this.rtf.getElementsByTagName("style"),n=0;r=l[n++];)r.innerHTML=r.innerHTML.replace(/body/g,"#rtf"+this._uid),r.setAttribute("scoped","true");!this._observer&&this.lazyLoad&&IntersectionObserver&&(this._observer=new IntersectionObserver((e=>{for(let t,i=0;t=e[i++];)t.isIntersecting&&(t.target.src=t.target.getAttribute("data-src"),t.target.removeAttribute("data-src"),this._observer.unobserve(t.target))}),{rootMargin:"500px 0px 500px 0px"}));var c=this,u=this.rtf.getElementsByTagName("title");u.length&&this.autosetTitle&&t({title:u[0].innerText});var d=e=>{var t=e.getAttribute("src");this.domain&&t&&("/"==t[0]?"/"==t[1]?e.src=(this.domain.includes("://")?this.domain.split("://")[0]:"")+":"+t:e.src=this.domain+t:t.includes("://")||0==t.indexOf("data:")||(e.src=this.domain+"/"+t))};this.imgList.length=0;var m=this.rtf.getElementsByTagName("img");for(let e,t=0,a=0;e=m[t];t++)parseInt(e.style.width||e.getAttribute("width"))>F&&(e.style.height="auto"),d(e),e.hasAttribute("ignore")||"A"==e.parentElement.nodeName||(e.i=a++,c.imgList.push(e.getAttribute("original-src")||e.src||e.getAttribute("data-src")),e.onclick=function(e){e.stopPropagation();var t=c.preview;this.ignore=()=>t=!1,c.$emit("imgtap",this),t&&i({current:this.i,urls:c.imgList})}),e.onerror=function(){c.$emit("error",{source:"img",target:this})},c.lazyLoad&&this._observer&&e.src&&0!=e.i&&(e.setAttribute("data-src",e.src),e.removeAttribute("src"),this._observer.observe(e));var h=this.rtf.getElementsByTagName("a");for(var p of h)p.onclick=function(e){e.stopPropagation();var t=!0,i=this.getAttribute("href");if(c.$emit("linkpress",{href:i,ignore:()=>t=!1}),t&&i)if("#"==i[0])c.useAnchor&&c.navigateTo({id:i.substr(1)});else{if(0==i.indexOf("http")||0==i.indexOf("//"))return!0;a({url:i})}return!1};var f=this.rtf.getElementsByTagName("video");c.videoContexts=f;for(let e,t=0;e=f[t++];)d(e),e.style.maxWidth="100%",e.onerror=function(){c.$emit("error",{source:"video",target:this})},e.onplay=function(){if(c.autopause)for(let e,t=0;e=c.videoContexts[t++];)e!=this&&e.pause()};var g,_=this.rtf.getElementsByTagName("audio");for(var v of _)d(v),v.onerror=function(){c.$emit("error",{source:"audio",target:this})};if(this.autoscroll){var y=this.rtf.getElementsByTagName("table");for(var b of y){let e=document.createElement("div");e.style.overflow="scroll",b.parentNode.replaceChild(e,b),e.appendChild(b)}}s||this.document.appendChild(this.rtf),this.$nextTick((()=>{this.nodes=[1],this.$emit("load")})),setTimeout((()=>this.showAm=""),500),clearInterval(this._timer),this._timer=setInterval((()=>{this.rect=this.rtf.getBoundingClientRect(),this.rect.height==g&&(this.$emit("ready",this.rect),clearInterval(this._timer)),g=this.rect.height}),350),this.showWithAnimation&&!s&&(this.showAm="animation:_show .5s")}else this.rtf&&!s&&this.rtf.parentNode.removeChild(this.rtf)},getText(e=this.nodes){return this.rtf.innerText},in(e){e.page&&e.selector&&e.scrollTop&&(this._in=e)},navigateTo(e){if(!this.useAnchor)return e.fail&&e.fail("Anchor is disabled");var t=s().in(this._in?this._in.page:this).select((this._in?this._in.selector:"#_top")+(e.id?` #${e.id},${this._in?this._in.selector:"#_top"} .${e.id}`:"")).boundingClientRect();this._in?t.select(this._in.selector).scrollOffset().select(this._in.selector).boundingClientRect():t.selectViewport().scrollOffset(),t.exec((t=>{if(!t[0])return e.fail&&e.fail("Label not found");var i=t[1].scrollTop+t[0].top-(t[2]?t[2].top:0)+(e.offset||0);this._in?this._in.page[this._in.scrollTop]=i:o({scrollTop:i,duration:300}),e.success&&e.success()}))},getVideoContext(e){if(!e)return this.videoContexts;for(var t=this.videoContexts.length;t--;)if(this.videoContexts[t].id==e)return this.videoContexts[t]},_handleHtml(e,t){if(!t){var i="<style scoped>@keyframes _show{0%{opacity:0}100%{opacity:1}}.u-parse img{max-width:100%}";for(var a in H)i+=`.u-parse ${a}{${H[a]}}`;for(a in this.tagStyle)i+=`.u-parse ${a}{${this.tagStyle[a]}}`;e=(i+="</style>")+e}return e.includes("rpx")&&(e=e.replace(/[0-9.]+\s*rpx/g,(e=>parseFloat(e)*F/750+"px"))),e}}},[["render",function(e,t,i,a,s,o){const f=p;return r(),l(f,{class:"u-parse"},{default:n((()=>[s.nodes.length?u("",!0):c(e.$slots,"default",{key:0},void 0,!0),d(f,{id:"_top",style:m(s.showAm+(i.selectable?";user-select:text;-webkit-user-select:text":""))},{default:n((()=>[h("div",{id:"rtf"+s.uid},null,8,["id"])])),_:1},8,["style"])])),_:3})}],["__scopeId","data-v-eff5cac8"]]);const P=L({name:"u-empty",props:{src:{type:String,default:""},text:{type:String,default:""},color:{type:String,default:"#c0c4cc"},iconColor:{type:String,default:"#c0c4cc"},iconSize:{type:[String,Number],default:120},fontSize:{type:[String,Number],default:26},mode:{type:String,default:"data"},imgWidth:{type:[String,Number],default:120},imgHeight:{type:[String,Number],default:"auto"},show:{type:Boolean,default:!0},marginTop:{type:[String,Number],default:0},iconStyle:{type:Object,default:()=>({})}},data:()=>({icons:{car:"购物车为空",page:"页面不存在",search:"没有搜索结果",address:"没有收货地址",wifi:"没有WiFi",order:"订单为空",coupon:"没有优惠券",favor:"暂无收藏",permission:"无权限",history:"无历史记录",news:"无新闻列表",message:"消息列表为空",list:"列表为空",data:"数据为空"}})},[["render",function(e,t,i,a,s,o){const h=E(f("u-icon"),j),g=p;return i.show?(r(),l(g,{key:0,class:"u-empty",style:m({marginTop:i.marginTop+"rpx"})},{default:n((()=>[d(h,{name:i.src?i.src:"empty-"+i.mode,"custom-style":i.iconStyle,label:i.text?i.text:s.icons[i.mode],"label-pos":"bottom","label-color":i.color,"label-size":i.fontSize,size:i.iconSize,color:i.iconColor,"margin-top":"14"},null,8,["name","custom-style","label","label-color","label-size","size","color"]),d(g,{class:"u-slot-wrap"},{default:n((()=>[c(e.$slots,"bottom",{},void 0,!0)])),_:3})])),_:3},8,["style"])):u("",!0)}],["__scopeId","data-v-f4267db2"]]),U=L({__name:"detail",setup(e){const t=e,i=t.id,a=g.database(),s=_({});s.value.user_id,_("拿个勾八，全是bug");const o=_(!1),c=g.importObject("utilsObj"),m=_(""),h=_(0),L=async()=>{const e=Date.now();e-h.value<1e3?y({title:"操作太频繁，请稍后！！",icon:"none"}):(h.value=e,o.value?s.value.like_count--:s.value.like_count++,o.value=!o.value,(async()=>{(await a.collection("quanzi_like").where(`article_id  == "${i}" && user_id == $cloudEnv_uid`).count()).result.total?(a.collection("quanzi_like").where(`article_id  == "${i}" && user_id == $cloudEnv_uid`).remove(),c.operation("quanzi_article","like_count",i,-1)):(a.collection("quanzi_like").add({article_id:i}),c.operation("quanzi_article","like_count",i,1))})())},j=_([]),H=_({article_id:t.id,comment_type:0}),R=_([]),F=e=>{R.value.unshift({...e,...H,user_id:[N.userInfo]})},W=e=>{const t=R.value.findIndex((t=>t._id==e.id));R.value.splice(t,1)};return v((async()=>{if(!t.id)return y({title:"参数有误",icon:" none"}),void setTimeout((()=>{b({url:"/pages/index/index"})}),500);await(async()=>{let e=await a.collection("quanzi_article").where(`_id=="${i}"`).getTemp(),t=a.collection("uni-id-users").field("_id,username,nickname,avatar_file").getTemp(),r=a.collection("quanzi_like").where(`article_id  == "${i}" && user_id == $cloudEnv_uid`).getTemp(),l=[e,t];N.hasLogin&&l.push(r),a.collection(...l).get({getOne:!0}).then((e=>{N.hasLogin&&(o.value=!!e.result.data._id.quanzi_like.length),s.value=e.result.data,m.value=s.value.user_id[0].nickname,console.log(e)}))})(),c.operation("quanzi_article","view_count",i,1),(()=>{const e=a.collection("quanzi_like").where(`article_id == "${t.id}"`).getTemp(),i=a.collection("uni-id-users").field("_id,avatar_file").getTemp();a.collection(e,i).get().then((e=>{j.value=e.result.data}))})(),(async()=>{let e=a.collection("quanzi_comment").where(`article_id == "${i}" && comment_type == 0`).orderBy("comment_date desc").getTemp(),t=a.collection("uni-id-users").field("_id,username,nickname,avatar_file").getTemp();const s=await a.collection(e,t).get(),o=s.result.data.map((e=>e._id)),r=await a.collection("quanzi_comment").where({reply_comment_id:a.command.in(o)}).groupBy("reply_comment_id").groupField("count(*) as totalReply").get();s.result.data.forEach((e=>{const t=r.result.data.findIndex((t=>t.reply_comment_id==e._id));t>-1&&(e.totalReply=r.result.data[t].totalReply)})),R.value=s.result.data})()})),(e,t)=>{const i=p,a=C,c=E(f("uni-dateformat"),B),h=E(f("u-parse"),D),g=S,_=E(f("u-empty"),P);return r(),l(i,{class:"detail"},{default:n((()=>[d(i,{class:"container"},{default:n((()=>[d(i,{class:"title"},{default:n((()=>[x(w(s.value.title),1)])),_:1}),d(i,{class:"userinfo"},{default:n((()=>[d(i,{class:"avatar"},{default:n((()=>[d(a,{src:I,mode:"aspectFill"})])),_:1}),d(i,{class:"text"},{default:n((()=>[d(i,{class:"name"},{default:n((()=>[x(w(m.value),1)])),_:1}),d(i,{class:"small"},{default:n((()=>[d(c,{date:s.value.publish_date,format:"MM月dd hh:mm",threshold:[6e4,2592e6]},null,8,["date"]),x(" · 发布于"+w(s.value.province),1)])),_:1})])),_:1})])),_:1}),d(i,{class:"content"},{default:n((()=>[d(i,{innerHTML:s.value.content},null,8,["innerHTML"]),d(h,{content:s.value.content,selectable:!0},null,8,["content"])])),_:1}),d(i,{class:"like"},{default:n((()=>[d(i,{class:k(["btn",o.value?"active":""]),onClick:L},{default:n((()=>[d(g,{class:"iconfont icon-good-fill"}),s.value.like_count>0?(r(),l(g,{key:0},{default:n((()=>[x(w(s.value.like_count),1)])),_:1})):u("",!0)])),_:1},8,["class"]),d(i,{class:"users"},{default:n((()=>[(r(!0),T($,null,z(j.value,(e=>(r(),l(a,{key:e,src:A(q)(e),mode:"aspectFill"},null,8,["src"])))),128))])),_:1}),d(i,{class:"text"},{default:n((()=>[d(g,{class:"num"},{default:n((()=>[x(w(s.value.view_count),1)])),_:1}),x(" 人看过 ")])),_:1})])),_:1})])),_:1}),d(i,{class:"comment"},{default:n((()=>[R.value.length?u("",!0):(r(),l(i,{key:0},{default:n((()=>[d(_,{text:"所谓伊人，在水一方",mode:"list"})])),_:1})),R.value.length?(r(),l(i,{key:1,class:"content"},{default:n((()=>[(r(!0),T($,null,z(R.value,(e=>(r(),l(i,{class:"item",key:e},{default:n((()=>[d(M,{item:e,onRemoveEnv:W},null,8,["item"])])),_:2},1024)))),128))])),_:1})):u("",!0)])),_:1}),d(O,{comment:H.value,onCommentEnv:F},null,8,["comment"])])),_:1})}}},[["__scopeId","data-v-3621d37c"]]);export{U as default};
