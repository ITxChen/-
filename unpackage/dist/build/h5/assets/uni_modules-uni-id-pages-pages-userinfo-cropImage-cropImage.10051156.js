import{N as t,s as i,P as e,Q as a,x as s,R as h,v as l,o,c as n,w as c,f as p,b as g,g as r,h as m,F as d,k as u,d as f,j as w,a as y,n as D,C as v,T,i as W,A as H,U as S,K as C,V as x}from"./index-071c8e17.js";import{_ as L}from"./_plugin-vue_export-helper.1b428a4d.js";function k(t,i){return Math.sqrt(Math.pow(t,2)+Math.pow(i,2))}function Y(t,i){const e=i.touches[0].clientX,a=i.touches[0].clientY;let{clipWidth:s,clipHeight:h,clipY:l,clipX:o,clipStart:n,isLockRatio:c,maxWidth:p,minWidth:g,maxHeight:r,minHeight:m}=t;p/=2,g/=2,m/=2,r/=2;let d=s,u=h,f=l,w=o,y=()=>(d=d<=p?d>=g?d:g:p,u=u<=r?u>=m?u:m:r,!(d>p||d<g||u>r||u<m)||!c);switch(u=n.height+(n.corner>1&&n.corner<4?1:-1)*(n.y-a),n.corner){case 1:if(d=n.width-n.x+e,c&&(u=d/(s/h)),!y())return;break;case 2:if(d=n.width-n.x+e,c&&(u=d/(s/h)),!y())return;f=n.clipY-(u-n.height);break;case 3:if(d=n.width+n.x-e,c&&(u=d/(s/h)),!y())return;f=n.clipY-(u-n.height),w=n.clipX-(d-n.width);break;case 4:if(d=n.width+n.x-e,c&&(u=d/(s/h)),!y())return;w=n.clipX-(d-n.width)}return{width:d,height:u,clipX:w,clipY:f}}const M=""+new URL("photo-6f69f4e3.svg",import.meta.url).href,X=""+new URL("rotate-9f2e0410.svg",import.meta.url).href,b={};const $=L({components:{limeClipper:L({name:"l-clipper",props:{value:{type:Boolean,default:!0},customStyle:{type:String},canvasId:{type:String,default:"l-clipper"},zIndex:{type:Number,default:99},imageUrl:{type:String},fileType:{type:String,default:"png"},quality:{type:Number,default:1},width:{type:Number,default:400},height:{type:Number,default:400},minWidth:{type:Number,default:200},maxWidth:{type:Number,default:600},minHeight:{type:Number,default:200},maxHeight:{type:Number,default:600},isLockWidth:{type:Boolean,default:!1},isLockHeight:{type:Boolean,default:!1},isLockRatio:{type:Boolean,default:!0},scaleRatio:{type:Number,default:1},minRatio:{type:Number,default:.5},maxRatio:{type:Number,default:2},isDisableScale:{type:Boolean,default:!1},isDisableRotate:{type:Boolean,default:!1},isLimitMove:{type:Boolean,default:!1},isShowPhotoBtn:{type:Boolean,default:!0},isShowRotateBtn:{type:Boolean,default:!0},isShowConfirmBtn:{type:Boolean,default:!0},isShowCancelBtn:{type:Boolean,default:!0},rotateAngle:{type:Number,default:90},source:{type:Object,default:()=>({album:"从相册中选择",camera:"拍照"})}},data(){return{canvasWidth:0,canvasHeight:0,clipX:0,clipY:0,clipWidth:0,clipHeight:0,animation:!1,imageWidth:0,imageHeight:0,imageTop:0,imageLeft:0,scale:1,angle:0,image:this.imageUrl,sysinfo:{},throttleTimer:null,throttleFlag:!0,timeClipCenter:null,flagClipTouch:!1,flagEndTouch:!1,clipStart:{},animationTimer:null,touchRelative:[{x:0,y:0}],hypotenuseLength:0,ctx:null}},computed:{clipStyle(){const{clipWidth:t,clipHeight:i,clipY:e,clipX:a,animation:s}=this;return`\n\t\t\twidth: ${t}px;\n\t\t\theight:${i}px;\n\t\t\ttransition-property: ${s?"":"background"};\n\t\t\tleft: ${a}px;\n\t\t\ttop: ${e}px\n\t\t\t`},imageStyle(){const{imageWidth:t,imageHeight:i,imageLeft:e,imageTop:a,animation:s,scale:h,angle:l}=this;return`\n\t\t\t\twidth: ${t?t+"px":"auto"};\n\t\t\t\theight: ${i?i+"px":"auto"};\n\t\t\t\ttransform: translate3d(${e-t/2}px, ${a-i/2}px, 0) scale(${h}) rotate(${l}deg);\n\t\t\t\ttransition-duration: ${s?.35:0}s\n\t\t\t`},clipSize(){const{clipWidth:t,clipHeight:i}=this;return{clipWidth:t,clipHeight:i}},clipPoint(){const{clipY:t,clipX:i}=this;return{clipY:t,clipX:i}}},watch:{value(t){if(t){if(this.imageUrl){const{imageWidth:t,imageHeight:i,imageLeft:e,imageTop:a,scale:s,clipX:h,clipY:l,clipWidth:o,clipHeight:n,path:c}=(null==b?void 0:b[this.imageUrl])||{};c!=this.image?this.image=this.imageUrl:this.setDiffData({imageWidth:t,imageHeight:i,imageLeft:e,imageTop:a,scale:s,clipX:h,clipY:l,clipWidth:o,clipHeight:n})}}else this.animation=0,this.angle=0},imageUrl(t){this.image=t},image:{handler:async function(t){this.getImageInfo(t)}},clipSize({widthVal:t,heightVal:i}){let{minWidth:e,minHeight:a}=this;e/=2,a/=2,t<e&&this.setDiffData({clipWidth:e}),i<a&&this.setDiffData({clipHeight:a}),this.calcClipSize()},angle(t){this.animation=!0,this.moveStop();const{isLimitMove:i}=this;i&&t%90&&this.setDiffData({angle:90*Math.round(t/90)}),this.imgMarginDetectionScale()},animation(t){if(clearTimeout(this.animationTimer),t){let t=setTimeout((()=>{this.setDiffData({animation:!1})}),260);this.setDiffData({animationTimer:t}),this.animationTimer=t}},isLimitMove(t){t&&(this.angle%90&&this.setDiffData({angle:90*Math.round(this.angle/90)}),this.imgMarginDetectionScale())},clipPoint(){this.cutDetectionPosition()},width(t,i){t!==i&&this.setDiffData({clipWidth:t/2})},height(t,i){t!==i&&this.setDiffData({clipHeight:t/2})}},mounted(){const i=t();this.sysinfo=i,this.setClipInfo(),this.image&&this.getImageInfo(this.image),this.setClipCenter(),this.calcClipSize(),this.cutDetectionPosition()},methods:{setDiffData(t){Object.keys(t).forEach((i=>{this[i]!==t[i]&&(this[i]=t[i])}))},getImageInfo(t){t&&(this.value&&i({title:"请稍候...",mask:!0}),e({src:t,success:i=>{this.imgComputeSize(i.width,i.height),this.image=i.path,this.isLimitMove&&(this.imgMarginDetectionScale(),this.$emit("ready",i));const{imageWidth:e,imageHeight:a,imageLeft:s,imageTop:h,scale:l,clipX:o,clipY:n,clipWidth:c,clipHeight:p}=this;b[t]=Object.assign(i,{imageWidth:e,imageHeight:a,imageLeft:s,imageTop:h,scale:l,clipX:o,clipY:n,clipWidth:c,clipHeight:p})},fail:t=>{this.imgComputeSize(),this.isLimitMove&&this.imgMarginDetectionScale()}}))},setClipInfo(){const{width:t,height:i,sysinfo:e,canvasId:s}=this,h=t/2,l=i/2,o=(e.windowHeight-l)/2,n=(e.windowWidth-h)/2,c=e.windowWidth/2,p=e.windowHeight/2;this.ctx=a(s,this),this.clipWidth=h,this.clipHeight=l,this.clipX=n,this.clipY=o,this.canvasHeight=l,this.canvasWidth=h,this.imageLeft=c,this.imageTop=p},setClipCenter(){const{sysInfo:i,clipHeight:e,clipWidth:a,imageTop:s,imageLeft:h}=this;let l=i||t(),o=.5*(l.windowHeight-e),n=.5*(l.windowWidth-a);this.imageTop=s-this.clipY+o,this.imageLeft=h-this.clipX+n,this.clipY=o,this.clipX=n},calcClipSize(){const{clipHeight:t,clipWidth:i,sysinfo:e,clipX:a,clipY:s}=this;i>e.windowWidth?this.setDiffData({clipWidth:e.windowWidth}):i+a>e.windowWidth&&this.setDiffData({clipX:e.windowWidth-a}),t>e.windowHeight?this.setDiffData({clipHeight:e.windowHeight}):t+s>e.windowHeight&&(this.clipY=e.windowHeight-s,this.setDiffData({clipY:e.windowHeight-s}))},cutDetectionPosition(){const{clipX:t,clipY:i,sysinfo:e,clipHeight:a,clipWidth:s}=this;let h=()=>{i<0&&this.setDiffData({clipY:0}),i>e.windowHeight-a&&this.setDiffData({clipY:e.windowHeight-a})},l=()=>{t<0&&this.setDiffData({clipX:0}),t>e.windowWidth-s&&this.setDiffData({clipX:e.windowWidth-s})};if(null===i&&null===t){let t=.5*(e.windowHeight-a),i=.5*(e.windowWidth-s);this.setDiffData({clipX:i,clipY:t})}else null!==i&&null!==t?(h(),l()):null!==i&&null===t?(h(),this.setDiffData({clipX:(e.windowWidth-s)/2})):null===i&&null!==t&&(l(),this.setDiffData({clipY:(e.windowHeight-a)/2}))},imgComputeSize(i,e){const{imageWidth:a,imageHeight:s}=function(i,e,a){let s=i,h=e,{clipWidth:l,clipHeight:o,sysinfo:n,width:c,height:p}=a;s&&h?s/h>(l||c)/(l||p)?(h=o||p,s=i/e*h):(s=l||c,h=e/i*s):(s=(n||t()).windowWidth,h=0);return{imageWidth:s,imageHeight:h}}(i,e,this);this.imageWidth=a,this.imageHeight=s},imgMarginDetectionScale(t){if(!this.isLimitMove)return;const i=function(t,i){i=i||t.scale;let{imageWidth:e,imageHeight:a,clipWidth:s,clipHeight:h,angle:l}=t;return l/90%2&&(e=a,a=e),e*i<s&&(i=s/e),a*i<h&&(i=Math.max(i,h/a)),i}(this,t);this.imgMarginDetectionPosition(i)},imgMarginDetectionPosition(t){if(!this.isLimitMove)return;const{scale:i,left:e,top:a}=function(t,i){let e=t.imageLeft,a=t.imageTop;i=i||t.scale;let s=t.imageWidth,h=t.imageHeight;t.angle/90%2&&(s=t.imageHeight,h=t.imageWidth);const{clipX:l,clipWidth:o,clipY:n,clipHeight:c}=t,p=t=>t*i/2,g=p(s),r=p(h);return e=l+g>=e?e:l+g,e=l+o-g<=e?e:l+o-g,a=n+r>=a?a:n+r,a=n+c-r<=a?a:n+c-r,{left:e,top:a,scale:i}}(this,t);this.setDiffData({imageLeft:e,imageTop:a,scale:i})},throttle(){this.setDiffData({throttleFlag:!0})},moveDuring(){clearTimeout(this.timeClipCenter)},moveStop(){clearTimeout(this.timeClipCenter);const t=setTimeout((()=>{this.animation||this.setDiffData({animation:!0}),this.setClipCenter()}),800);this.setDiffData({timeClipCenter:t})},clipTouchStart(t){if(t.preventDefault(),!this.image)return void s({title:"请选择图片",icon:"none",duration:3e3});const i=t.touches[0].clientX,e=t.touches[0].clientY,{clipX:a,clipY:h,clipWidth:l,clipHeight:o}=this,n=function(t,i,e,a,s,h){let l;const o=[t+e/2,i+a/2],n=[s,h];return n[0]<=o[0]&&n[1]<=o[1]?l=3:n[0]>=o[0]&&n[1]<=o[1]?l=2:n[0]<=o[0]&&n[1]>=o[1]?l=4:n[0]>=o[0]&&n[1]>=o[1]&&(l=1),l}(a,h,l,o,i,e);this.moveDuring(),n&&(this.clipStart={width:l,height:o,x:i,y:e,clipY:h,clipX:a,corner:n},this.flagClipTouch=!0,this.flagEndTouch=!0)},clipTouchMove(t){if(t.stopPropagation(),t.preventDefault(),!this.image)return void s({title:"请选择图片",icon:"none",duration:3e3});if(1!==t.touches.length)return;const{flagClipTouch:i,throttleFlag:e}=this;if(i&&e){const{isLockRatio:i,isLockHeight:e,isLockWidth:a}=this;if(i&&(a||e))return;this.setDiffData({throttleFlag:!1}),this.throttle();const s=Y(this,t);if(s){const{width:t,height:i,clipX:h,clipY:l}=s;a||e?a?e||this.setDiffData({clipHeight:i,clipY:l}):this.setDiffData({clipWidth:t,clipX:h}):this.setDiffData({clipWidth:t,clipHeight:i,clipX:h,clipY:l}),this.imgMarginDetectionScale()}}},clipTouchEnd(){this.moveStop(),this.flagClipTouch=!1},imageTouchStart(t){event.preventDefault(),this.flagEndTouch=!1;const{imageLeft:i,imageTop:e}=this,a=t.touches[0].clientX,s=t.touches[0].clientY;let h=[];if(1===t.touches.length)h[0]={x:a-i,y:s-e},this.touchRelative=h;else{const l=t.touches[1].clientX,o=t.touches[1].clientY;const n=k(Math.abs(a-l),Math.abs(s-o));h=[{x:a-i,y:s-e},{x:l-i,y:o-e}],this.touchRelative=h,this.hypotenuseLength=n}},imageTouchMove(t){event.preventDefault();const{flagEndTouch:i,throttleFlag:e}=this;if(i||!e)return;const a=t.touches[0].clientX,s=t.touches[0].clientY;if(this.setDiffData({throttleFlag:!1}),this.throttle(),this.moveDuring(),1===t.touches.length){const{left:t,top:i}=function(t,i,e){return{left:i-t.touchRelative[0].x,top:e-t.touchRelative[0].y}}(this,a,s);this.setDiffData({imageLeft:t,imageTop:i}),this.imgMarginDetectionPosition()}else{const i=t.touches[1].clientX,e=t.touches[1].clientY;let h=Math.abs(a-i),l=Math.abs(s-e),o=k(h,l),n=this.scale*(o/this.hypotenuseLength);this.isDisableScale?n=1:(n=n<=this.minRatio?this.minRatio:n,n=n>=this.maxRatio?this.maxRatio:n,this.$emit("change",{width:this.imageWidth*n,height:this.imageHeight*n})),this.imgMarginDetectionScale(n),this.hypotenuseLength=Math.sqrt(Math.pow(h,2)+Math.pow(l,2)),this.scale=n}},imageTouchEnd(){this.setDiffData({flagEndTouch:!0}),this.moveStop()},uploadImage(){const t=Object.entries(this.source),i=["original","compressed"],e=({tempFilePaths:t,tempFiles:i})=>{this.image=t?t[0]:i[0].path},a=t=>{"message"!==t&&v({count:1,sizeType:i,sourceType:[t],success:e})};t.length>1?h({itemList:t.map((t=>t[1])),success:({tapIndex:i})=>{a(t[i][0])}}):a(t[0][0])},imageReset(){const i=this.sysinfo||t();this.scale=1,this.angle=0,this.imageTop=i.windowHeight/2,this.imageLeft=i.windowWidth/2},imageLoad(t){this.imageReset(),l(),this.$emit("ready",t.detail)},rotate(t){if(this.isDisableRotate)return;if(!this.image)return void s({title:"请选择图片",icon:"none",duration:3e3});const{rotateAngle:i}=this,e=this.angle,a=t.currentTarget.dataset.type;this.angle="along"===a?e+i:e-i,this.$emit("rotate",this.angle)},confirm(){if(!this.image)return void s({title:"请选择图片",icon:"none",duration:3e3});i({title:"加载中"});const{canvasHeight:t,canvasWidth:e,clipHeight:a,clipWidth:h,ctx:o,scale:n,imageLeft:c,imageTop:p,clipX:g,clipY:r,angle:m,scaleRatio:d,image:u,quality:f,fileType:w,type:y,canvasId:D}=this,v=()=>{const t=this.imageWidth*n*d,i=this.imageHeight*n*d,e=c-g,s=p-r;o.translate(e*d,s*d),o.rotate(m*Math.PI/180),o.drawImage(u,-t/2,-i/2,t,i),o.draw(!1,(()=>{const t=h*d,i=a*d;let e={x:0,y:0,width:t,height:i,destWidth:t,destHeight:i,canvasId:D,fileType:w,quality:f,success:t=>{s.url=t.tempFilePath,l(),this.$emit("success",s),this.$emit("input",!1)},fail:t=>{console.error("error",t),this.$emit("fail",t),this.$emit("input",!1)}},s={url:"",width:t,height:i};T(e,this)}))};e!==h||t!==a?(this.canvasWidth=h,this.canvasHeight=a,o.draw(),this.$nextTick((()=>{setTimeout((()=>{v()}),100)}))):v()},cancel(){this.$emit("cancel",!1),this.$emit("input",!1)}}},[["render",function(t,i,e,a,s,h){const l=W,v=H,T=S;return o(),n(l,{class:D(["l-clipper",{open:e.value}]),"disable-scroll":"",style:g("z-index: "+e.zIndex+";"+e.customStyle)},{default:c((()=>[p(l,{class:"l-clipper-mask",onTouchstart:u(h.clipTouchStart,["stop","prevent"]),onTouchmove:u(h.clipTouchMove,["stop","prevent"]),onTouchend:u(h.clipTouchEnd,["stop","prevent"])},{default:c((()=>[p(l,{class:"l-clipper__content",style:g(h.clipStyle)},{default:c((()=>[(o(),r(d,null,m([0,0,0,0],((t,i)=>p(l,{class:"l-clipper__edge",key:i}))),64))])),_:1},8,["style"])])),_:1},8,["onTouchstart","onTouchmove","onTouchend"]),s.image?(o(),n(v,{key:0,class:"l-clipper-image",onError:h.imageLoad,onLoad:h.imageLoad,onTouchstart:u(h.imageTouchStart,["stop","prevent"]),onTouchmove:u(h.imageTouchMove,["stop","prevent"]),onTouchend:u(h.imageTouchEnd,["stop","prevent"]),src:s.image,mode:"auto"==s.imageWidth?"widthFix":"",style:g(h.imageStyle)},null,8,["onError","onLoad","onTouchstart","onTouchmove","onTouchend","src","mode","style"])):f("",!0),p(T,{"canvas-id":e.canvasId,id:"l-clipper","disable-scroll":"",style:g("width: "+s.canvasWidth*e.scaleRatio+"px; height:"+s.canvasHeight*e.scaleRatio+"px;"),class:"l-clipper-canvas"},null,8,["canvas-id","style"]),p(l,{class:"l-clipper-tools"},{default:c((()=>[p(l,{class:"l-clipper-tools__btns"},{default:c((()=>[e.isShowCancelBtn?(o(),n(l,{key:0,onClick:h.cancel},{default:c((()=>[t.$slots.cancel?w(t.$slots,"cancel",{key:0},void 0,!0):(o(),n(l,{key:1,class:"cancel"},{default:c((()=>[y("取消")])),_:1}))])),_:3},8,["onClick"])):f("",!0),e.isShowPhotoBtn?(o(),n(l,{key:1,onClick:h.uploadImage},{default:c((()=>[t.$slots.photo?w(t.$slots,"photo",{key:0},void 0,!0):(o(),n(v,{key:1,src:M}))])),_:3},8,["onClick"])):f("",!0),e.isShowRotateBtn?(o(),n(l,{key:2,onClick:h.rotate},{default:c((()=>[t.$slots.rotate?w(t.$slots,"rotate",{key:0},void 0,!0):(o(),n(v,{key:1,src:X,"data-type":"inverse"}))])),_:3},8,["onClick"])):f("",!0),e.isShowConfirmBtn?(o(),n(l,{key:3,onClick:h.confirm},{default:c((()=>[t.$slots.confirm?w(t.$slots,"confirm",{key:0},void 0,!0):(o(),n(l,{key:1,class:"confirm"},{default:c((()=>[y("确定")])),_:1}))])),_:3},8,["onClick"])):f("",!0)])),_:3}),w(t.$slots,"default",{},void 0,!0)])),_:3})])),_:3},8,["class","style"])}],["__scopeId","data-v-592a86cd"]])},data:()=>({path:"",options:{width:600,height:600}}),onLoad({path:t,options:i}){this.path=t,i&&(this.options=JSON.parse(i))},methods:{successFn(t){this.getOpenerEventChannel().emit("success",t.url),C()},cancel(){C()}}},[["render",function(t,i,e,a,s,h){const l=x("limeClipper"),g=W;return o(),n(g,{class:"content"},{default:c((()=>[p(l,{width:s.options.width,"scale-ratio":2,"is-lock-width":!1,"is-lock-height":!1,height:s.options.height,"image-url":s.path,onSuccess:h.successFn,onCancel:h.cancel},null,8,["width","height","image-url","onSuccess","onCancel"])])),_:1})}],["__scopeId","data-v-c2c356f4"]]);export{$ as default};
